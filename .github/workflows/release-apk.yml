name: Build and Release Mobile

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        shell: bash
        run: |
          sdkmanager --install "platform-tools" "platforms;android-35" "build-tools;35.0.0"
          yes | sdkmanager --licenses || true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Flutter pub get
        working-directory: arcade-staff-flutter
        run: flutter pub get

      - name: Verify signing secrets
        shell: bash
        run: |
          if [[ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]]; then
            echo "Missing ANDROID_KEYSTORE_BASE64 secret" >&2
            exit 1
          fi
          if [[ -z "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" ]]; then
            echo "Missing ANDROID_KEYSTORE_PASSWORD secret" >&2
            exit 1
          fi
          if [[ -z "${{ secrets.ANDROID_KEY_PASSWORD }}" ]]; then
            echo "Missing ANDROID_KEY_PASSWORD secret" >&2
            exit 1
          fi
          if [[ -z "${{ secrets.ANDROID_KEY_ALIAS }}" ]]; then
            echo "Missing ANDROID_KEY_ALIAS secret" >&2
            exit 1
          fi

      - name: Decode release keystore
        shell: bash
        run: |
          mkdir -p arcade-staff-flutter/android/keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > arcade-staff-flutter/android/keystore/release.jks

      - name: Write key.properties
        shell: bash
        run: |
          cat > arcade-staff-flutter/android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=../keystore/release.jks
          EOF

      - name: Build release APKs (split per ABI)
        working-directory: arcade-staff-flutter
        run: flutter build apk --release --split-per-abi --target-platform android-arm,android-arm64,android-x64

      - name: Prepare versioned APK files
        id: prep_apk
        shell: bash
        run: |
          mkdir -p dist
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="build-${GITHUB_RUN_NUMBER}"
          fi
          ARTIFACT_NAME="insights-staff-${TAG}-apk-split"
          cp arcade-staff-flutter/build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk "dist/insights-staff-${TAG}-armeabi-v7a.apk"
          cp arcade-staff-flutter/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk "dist/insights-staff-${TAG}-arm64-v8a.apk"
          cp arcade-staff-flutter/build/app/outputs/flutter-apk/app-x86_64-release.apk "dist/insights-staff-${TAG}-x86_64.apk"
          echo "apk_files=dist/*.apk" >> "$GITHUB_OUTPUT"
          echo "artifact_name=${ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"

      - name: Resolve release metadata
        id: release_meta
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF_NAME}"
            NAME="${GITHUB_REF_NAME}"
            PRERELEASE="false"
          else
            TAG="build-${GITHUB_RUN_NUMBER}"
            NAME="Automated build ${GITHUB_RUN_NUMBER}"
            PRERELEASE="true"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prep_apk.outputs.artifact_name }}
          path: ${{ steps.prep_apk.outputs.apk_files }}

  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Flutter pub get
        working-directory: arcade-staff-flutter
        run: flutter pub get

      - name: Build iOS app (no codesign)
        working-directory: arcade-staff-flutter
        run: flutter build ios --release --no-codesign

      - name: Prepare versioned iOS artifact
        id: prep_ios
        shell: bash
        run: |
          mkdir -p dist
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="build-${GITHUB_RUN_NUMBER}"
          fi
          APP_PATH="arcade-staff-flutter/build/ios/iphoneos/Runner.app"
          if [[ ! -d "${APP_PATH}" ]]; then
            echo "Runner.app not found at ${APP_PATH}" >&2
            exit 1
          fi
          IOS_ZIP="dist/insights-staff-${TAG}-ios-runner.app.zip"
          ditto -c -k --sequesterRsrc --keepParent "${APP_PATH}" "${IOS_ZIP}"
          echo "ios_file=${IOS_ZIP}" >> "$GITHUB_OUTPUT"
          echo "artifact_name=insights-staff-${TAG}-ios" >> "$GITHUB_OUTPUT"

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prep_ios.outputs.artifact_name }}
          path: ${{ steps.prep_ios.outputs.ios_file }}

  publish-release:
    runs-on: ubuntu-latest
    needs:
      - build-android
      - build-ios

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve release notes file
        id: notes
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="build-${GITHUB_RUN_NUMBER}"
          fi
          NOTES_FILE=".github/release-notes/${TAG}.md"
          if [[ -f "${NOTES_FILE}" ]]; then
            echo "has_notes=true" >> "$GITHUB_OUTPUT"
            echo "notes_file=${NOTES_FILE}" >> "$GITHUB_OUTPUT"
          else
            echo "has_notes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve release metadata
        id: release_meta
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF_NAME}"
            NAME="${GITHUB_REF_NAME}"
            PRERELEASE="false"
          else
            TAG="build-${GITHUB_RUN_NUMBER}"
            NAME="Automated build ${GITHUB_RUN_NUMBER}"
            PRERELEASE="true"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Prepare release files list
        id: release_files
        shell: bash
        run: |
          mapfile -t FILES < <(find dist -type f \( -name "*.apk" -o -name "*.zip" \) | sort)
          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "No release files found" >&2
            exit 1
          fi
          {
            echo "files<<EOF"
            printf '%s\n' "${FILES[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Publish GitHub Release with custom notes
        if: steps.notes.outputs.has_notes == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: ${{ steps.release_meta.outputs.name }}
          prerelease: ${{ steps.release_meta.outputs.prerelease }}
          target_commitish: ${{ github.sha }}
          files: ${{ steps.release_files.outputs.files }}
          generate_release_notes: false
          body_path: ${{ steps.notes.outputs.notes_file }}

      - name: Publish GitHub Release with generated notes (fallback)
        if: steps.notes.outputs.has_notes != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: ${{ steps.release_meta.outputs.name }}
          prerelease: ${{ steps.release_meta.outputs.prerelease }}
          target_commitish: ${{ github.sha }}
          files: ${{ steps.release_files.outputs.files }}
          generate_release_notes: true
