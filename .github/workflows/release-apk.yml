name: Build and Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-release-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        shell: bash
        run: |
          sdkmanager --install "platform-tools" "platforms;android-35" "build-tools;35.0.0"
          yes | sdkmanager --licenses || true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Flutter pub get
        working-directory: arcade-staff-flutter
        run: flutter pub get

      - name: Verify signing secrets
        shell: bash
        run: |
          if [[ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]]; then
            echo "Missing ANDROID_KEYSTORE_BASE64 secret" >&2
            exit 1
          fi
          if [[ -z "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" ]]; then
            echo "Missing ANDROID_KEYSTORE_PASSWORD secret" >&2
            exit 1
          fi
          if [[ -z "${{ secrets.ANDROID_KEY_PASSWORD }}" ]]; then
            echo "Missing ANDROID_KEY_PASSWORD secret" >&2
            exit 1
          fi
          if [[ -z "${{ secrets.ANDROID_KEY_ALIAS }}" ]]; then
            echo "Missing ANDROID_KEY_ALIAS secret" >&2
            exit 1
          fi

      - name: Decode release keystore
        shell: bash
        run: |
          mkdir -p arcade-staff-flutter/android/keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > arcade-staff-flutter/android/keystore/release.jks

      - name: Write key.properties
        shell: bash
        run: |
          cat > arcade-staff-flutter/android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=keystore/release.jks
          EOF

      - name: Build universal release APK
        working-directory: arcade-staff-flutter
        run: flutter build apk --release --target-platform android-arm,android-arm64,android-x64

      - name: Prepare versioned APK filename
        id: prep_apk
        shell: bash
        run: |
          mkdir -p dist
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="manual-${GITHUB_RUN_NUMBER}"
          fi
          OUT_FILE="insights-staff-${TAG}-universal.apk"
          ARTIFACT_NAME="insights-staff-${TAG}-universal"
          cp arcade-staff-flutter/build/app/outputs/flutter-apk/app-release.apk "dist/${OUT_FILE}"
          echo "apk_file=dist/${OUT_FILE}" >> "$GITHUB_OUTPUT"
          echo "artifact_name=${ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.prep_apk.outputs.artifact_name }}
          path: ${{ steps.prep_apk.outputs.apk_file }}

      - name: Resolve release notes file
        id: notes
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          NOTES_FILE=".github/release-notes/${GITHUB_REF_NAME}.md"
          if [[ -f "${NOTES_FILE}" ]]; then
            echo "has_notes=true" >> "$GITHUB_OUTPUT"
            echo "notes_file=${NOTES_FILE}" >> "$GITHUB_OUTPUT"
          else
            echo "has_notes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish GitHub Release with custom notes (on tag)
        if: startsWith(github.ref, 'refs/tags/') && steps.notes.outputs.has_notes == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.prep_apk.outputs.apk_file }}
          generate_release_notes: false
          body_path: ${{ steps.notes.outputs.notes_file }}

      - name: Publish GitHub Release with generated notes (fallback)
        if: startsWith(github.ref, 'refs/tags/') && steps.notes.outputs.has_notes != 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.prep_apk.outputs.apk_file }}
          generate_release_notes: true
